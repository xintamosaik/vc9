<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV - Drafts</title>

    <script src="../../shared.js"></script>
    <script src="../facts/work/index.js"></script>
    <script src="../facts/education/index.js"></script>
    <script src="../facts/skills/index.js"></script>
    <script src="../facts/summary/index.js"></script>


    <link rel="stylesheet" href="../../shared.css">
</head>

<body>
    <nav>
        <a href="../../">Home</a> >
        <a href="../">Editor</a> >
        <a href="./">Cvs</a> >
        Add | Save to preview

    </nav>

    <main>
        <h1>
            New CV
        </h1>
        <p>
            Here we can add a new CV for a specific company or position.
        </p>
        <form id="cv" action="./" method="get">
            <input type="hidden" name="id" value="">

            <input type="text" name="sector" id="sector" placeholder="Fintech">
            <label for="sector">Sector</label>

            <br />

            <input type="text" name="company" id="company" placeholder="Google">
            <label for="position">Company</label>

            <br />

            <input type="text" name="position" id="position" placeholder="Junior Software Engineer">
            <label for="position">Position</label>

            <br />

            <label for="summary">Summary</label>
            <textarea name="summary" id="summary" rows="8"
                placeholder="I am a software engineer with a passion for building scalable and efficient systems."></textarea>



            <template id="job">
                <div class="job entry" style="display:flex; flex-direction: column;">
                    <h3>
                        <span class="title"></span>
                        <span class="dash"></span>
                        <span class="company"></span>
                    </h3>
                    <h4>
                        <span class="date"></span>
                        <span class="dash"></span>
                        <span class="city"></span>
                    </h4>

                    <label for="description">
                        Description
                    </label>
                    <textarea class="description" name="description" rows="12"></textarea>
                </div>


            </template>
            <h2>Work Experience</h2>
            <output name="work" style="display: flex; flex-direction: column; gap: 2rem;"></output>



            <template id="education">
                <div class="education entry" style="display:flex; flex-direction: column;">
                    <h3>
                        <span class="subject"></span>
                        <span class="dash"></span>
                        <span class="university"></span>
                    </h3>
                    <h4>
                        <span class="date"></span>
                        <span class="dash"></span>
                        <span class="city"></span>
                    </h4>
                    <h4 class="degree"></h4>

                    <label for="description">
                        Description
                    </label>
                    <textarea class="description" name="description" rows="4"></textarea>
                </div>


            </template>
            <h2>Education</h2>
            <output name="education" style="display: flex; flex-direction: column; gap: 2rem;"></output>



            <template id="skill">
                <div class="skill entry" style="display:flex; flex-direction: column;">
                    <h3>
                        <input type="checkbox" class="active" checked>
                        <span class="name"></span>
                        <span class="dash"></span>
                        <span class="level"></span>
                        <span class="dash"></span>
                        <span class="description"></span>
                    </h3>
                </div>
            </template>
            <h2>Skills</h2>
            <output name="skills" style="display: flex; flex-direction: column;"></output>

            <button type="submit">Save</button>
        </form>


    </main>

    <script>
        const form = document.forms.cv;

        const title = Summary.title() || "";
        form.elements.position.value = title;

        const description = Summary.description() || "";
        form.elements.summary.value = description;

        const work = Work.all();
        work.forEach(job => {
            const clone = window.job.content.cloneNode(true);
            const container = clone.querySelector('.entry');
            const titleHTML = clone.querySelector('.title');
            const companyHTML = clone.querySelector('.company');
            const cityHTML = clone.querySelector('.city');
            const dateHTML = clone.querySelector('.date');
            const descriptionHTML = clone.querySelector('.description');

            container.dataset.id = job.id;

            titleHTML.textContent = job.title;
            companyHTML.textContent = job.company;
            cityHTML.textContent = job.city;
            dateHTML.textContent = job.start + " - " + job.end || "present";
            descriptionHTML.value = job.description;

            form.elements.work.appendChild(clone);
        });

        const educations = Education.all();
        educations.forEach(education => {

            const clone = window.education.content.cloneNode(true);
            const container = clone.querySelector('.entry');

            const subjectHTML = clone.querySelector('.subject');
            const degreeHTML = clone.querySelector('.degree');
            const cityHTML = clone.querySelector('.city');
            const dateHTML = clone.querySelector('.date');

            const descriptionHTML = clone.querySelector('.description');

            container.dataset.id = education.id;

            subjectHTML.textContent = education.subject;
            degreeHTML.textContent = education.degree;
            cityHTML.textContent = education.city;
            dateHTML.textContent = education.start + " - " + education.end || "present";
            descriptionHTML.value = education.description;

            form.elements.education.appendChild(clone);

        });

        const skills = Skills.all();
        skills.forEach(skill => {

            const clone = window.skill.content.cloneNode(true);
            const container = clone.querySelector('.entry');
            const nameHTML = clone.querySelector('.name');
            const levelHTML = clone.querySelector('.level');
            const descriptionHTML = clone.querySelector('.description');

            container.dataset.id = skill.id;

            nameHTML.textContent = skill.name;
            levelHTML.textContent = skill.level;
            descriptionHTML.value = skill.description;

            form.elements.skills.appendChild(clone);
        });

        // Do we have a cv id form the url?
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        console.log({ id })
        if (id) {
            const serialized = localStorage.getItem(`cv.${id}`);
            const data = JSON.parse(serialized);
            console.log({ data })

            if (data.sector) {
                form.elements.sector.value = data.sector;
            }

            if (data.company) {
                form.elements.company.value = data.company;
            }

            if (data.position) {
                form.elements.position.value = data.position;
            }

            if (data.summary) {
                form.elements.summary.value = data.summary;
            }

            const jobs = data.work;
            console.log({ jobs })

            jobs.forEach(job => {
                console.log({ job })
                const id = job.id;
                const jobHTML = form.elements.work.querySelector(`[data-id="${id}"]`);
                console.log({ jobHTML })
                const descriptionHTML = jobHTML.querySelector('.description');
                console.log({ descriptionHTML })
                console.log(job.description)
                descriptionHTML.value = job.description;

            });

        }

        form.addEventListener('submit', (event) => {
            event.preventDefault();
            const cv = event.target;

            const sector = cv.elements.sector.value;
            const company = cv.elements.company.value;
            const position = cv.elements.position.value;
            const summary = cv.elements.summary.value;
            console.log({ sector, company, position, summary })

            const jobs = Array.from(cv.elements.work.querySelectorAll('.job'));
            const jobsData = jobs.map(job => {
                const id = job.dataset.id;
                const descriptionHTML = job.querySelector('.description');
                console.log({ descriptionHTML })
                const description = descriptionHTML.value;
                console.log({ description })


                console.log({ id, description })
                return { id, description }
            })
            console.log({ jobsData })

            const educations = Array.from(cv.elements.education.querySelectorAll('.education'));
            const educationsData = educations.map(education => {

                const id = education.dataset.id;
                const description = education.querySelector('.description').value;
                return { id, description }
            })
            console.log({ educationsData })

            const skills = Array.from(cv.elements.skills.querySelectorAll('.skill'));
            console.log({ skills })
            const skillsData = skills.map(skill => {
                const id = skill.dataset.id;
                const active = skill.querySelector('.active').checked;
                return { id, active }
            })
            console.log({ skillsData })
            const timestamp = Date.now();
            const data = {
                id: id ? id : `${timestamp}`,
                sector,
                company,
                position,
                summary,
                work: jobsData,
                education: educationsData,
                skills: skillsData

            }
            console.log({ data })
            const serialized = JSON.stringify(data);
            localStorage.setItem(`cv.${id ? id : timestamp}`, serialized);
            // window.location.href = `./`;
        });


    </script>


</body>

</html>